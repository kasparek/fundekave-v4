/** DRAFT - temporary textarea data storing **/
var Draft={timer:3000,li:{},ta:function(id){this.id=id;this.old='';this.t=0;this.text=function(){return $.trim($('#'+this.id).val());};this.backup=function(){this.old=this.text();};this.restore=function(){$('#'+id).val(this.old);this.old='';};this.check=function(){this.backup();$(this.id).attr('disabled','disabled');Fajax.add('result', this.id);Fajax.send('draft-check');};this.setT=function(f,t){this.t=setTimeout(f,t);};this.clearT=function(){if(this.t)clearTimeout(this.t);this.t=null;};},init:function(){var o=Draft,l=[],f;listen('submit','click',o.submit);listen('draftable', 'keyup',o.key);if(window.location.hash=='#dd' || gup('dd',window.location)==1){o.dropAll(true);window.location.hash='';}$('.draftable').each(function(){var id=$(this).attr('id');if(!o.li[id])o.li[id]=new o.ta(id);o.li[id].check();});$('.draftable').each(function(){f=this.form;l.push($(this).attr('id'));});if(l.length>0) {$("#draftablesList").remove();$(f).append('<input id="draftablesList" type="hidden" name="draftable" value="'+l.join(',')+'" />');}},backup:function(id){var o=Draft;if(!o.li[id])o.li[id]=new o.ta(id);o.li[id].backup();},restore:function(id){var o=Draft;if(!o.li[id])o.li[id].restore();},hasdropAll:false,dropAll:function(override){var o=Draft;if(override)o.hasDropAll=true;if(!o.hasDropAll)return;o.hasDropAll=false;var l=[];$('.draftable').each(function(){var id=$(this).attr('id');$('#draftdrop'+id).remove();l.push(id);});if(l.length>0){Fajax.add('result', l.join(','));Fajax.send('draft-drop');}},dropClick:function(e){e.preventDefault();var o=Draft,id=gup('ta',$(e.currentTarget).attr('href'));if(o.li[id])o.li[id].restore();Fajax.add('result',id);Fajax.send('draft-drop');$(e.currentTarget).remove();return false;},unused:function(id){if($('#draftdrop'+id).length>0){Fajax.add('result',id);Fajax.send('draft-drop');$('#draftdrop'+id).remove();}},dropBackHandler:function(){Draft.hasDropAll=false;$('.draftable').each( function(){$('#draftdrop'+$(this).attr('id')).remove();});},submit:function(){var l=Draft.li;for(var id in l){l[id].clearT();$("#"+id).removeClass('draftNotSave').removeClass('draftSave');}},save:function(){for(var id in Draft.li){var t=Draft.li[id],text=t.text();if(text!=t.old && text.length>0){var f=Fajax;f.add('place',id);f.add('text',text);f.add('call','Draft.saveHandler;'+id);f.send('draft-save');t.old=text;}}},saveHandler:function(id){$("#"+id).removeClass('draftNotSave').addClass('draftSave');},key:function(){var o=Draft,id=$(this).attr('id');o.unused(id);if(o.li[id].text()!=o.li[id].old)$("#"+id).removeClass('draftSave').addClass('draftNotSave');o.li[id].clearT();o.li[id].setT(o.save,o.timer);}};